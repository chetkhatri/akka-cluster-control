<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Akka Cluster Control</title>
        <style>
            .joined {
                fill: LightGreen;
            }

            .up {
                fill: Green;
            }

            .left {
                fill: Gray;
            }

            .exited {
                fill: LightGray;
            }

            .unreachable {
                stroke: OrangeRed;
                stroke-width: 4px;
            }
        </style>
    </head>
    <body>
        <script src="js/d3.min.js"></script>
        <script>
            var width = 640,
                height = 480;
            var svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("heigth", height);
            var memberNodes = [];
            var memberNodeEvents = new EventSource("member-node-events");

            memberNodeEvents.addEventListener("joined", function(event) {
                var address = extractAddress(event);
                memberNodes.push({address: address, status: "joined", unreachable: false});
                refresh(memberNodes);
            });

            memberNodeEvents.addEventListener("up", function(event) {
                var address = extractAddress(event);
                var memberNodeExists = memberNodes.some(function(memberNode) {
                    return memberNode.address == address;
                });
                if (memberNodeExists) {
                    updateMemberNodes(
                        function(memberNode) {
                            memberNode.status = "up";
                            return memberNode;
                        },
                        event
                    );
                } else {
                    memberNodes.push({address: address, status: "up", unreachable: false});
                    refresh(memberNodes);
                }
            });

            ["left", "exited"].forEach(function(status) {
                memberNodeEvents.addEventListener(status, function(event) {
                    updateMemberNodes(
                        function(memberNode) {
                            memberNode.status = status;
                            return memberNode;
                        },
                        event
                    );
                });
            });

            memberNodeEvents.addEventListener("removed", function(event) {
                var address = extractAddress(event);
                memberNodes = memberNodes.filter(function(memberNode) {
                    return memberNode.address != address;
                });
                refresh(memberNodes);
            });

            memberNodeEvents.addEventListener("reachable", function(event) {
                updateMemberNodes(
                    function (memberNode) {
                        memberNode.unreachable = false;
                        return memberNode;
                    },
                    event
                );
            });

            memberNodeEvents.addEventListener("unreachable", function(event) {
                updateMemberNodes(
                    function (memberNode) {
                        memberNode.unreachable = true;
                        return memberNode;
                    },
                    event
                );
            });

            function updateMemberNodes(updated, event) {
                var address = extractAddress(event);
                memberNodes = memberNodes.map(function(memberNode) {
                    return memberNode.address == address ? updated(memberNode) : memberNode;
                });
                refresh(memberNodes);
            }

            function extractAddress(event) {
                return event.data.substring(event.data.indexOf("@") + 1);
            }

            function refresh(data) {
                var circles = svg.selectAll("circle").data(data, function(memberNode) {
                    return memberNode.address;
                });
                circles
                    .attr("class", function(d) {
                        return d.status;
                    })
                    .classed("unreachable", function(d) {
                        return d.unreachable;
                    });
                circles.enter().append("circle")
                    .attr("cx", function(d, i) {
                        return (i + 1) * 60;
                    })
                    .attr("cy", 60)
                    .attr("r", 20)
                    .attr("class", function(d) {
                        return d.status;
                    })
                    .classed("unreachable", function(d) {
                        return d.unreachable;
                    });
                circles.exit().remove();
            }
        </script>
    </body>
</html>
